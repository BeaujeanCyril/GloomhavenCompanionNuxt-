# Fix - Erreur 404 lors du chargement d'un scénario

## Problème rencontré

```
Error 404: Page not found: /api/campaigns/2/scenarios/1
```

## Cause racine

Le code du store essayait d'appeler un endpoint qui n'existe pas :
```typescript
// ❌ Cet endpoint n'existe pas
await useFetch(`/api/campaigns/${this.currentCampaign.id}/scenarios/${scenarioId}`)
```

Cet endpoint était utilisé dans l'ancienne architecture mais n'a jamais été créé dans la nouvelle structure avec `campaignScenarios`.

## ✅ Solution appliquée

### 1. Correction de `loadScenario()` - [stores/app.ts:197-252](stores/app.ts#L197-L252)

**Avant (avec appel API inexistant) :**
```typescript
async loadScenario(scenarioId: number) {
    if (!this.currentCampaign) return

    let scenario = this.currentCampaign.scenarios?.find(s => s.id === scenarioId)

    if (!scenario) {
        // ❌ Appel à un endpoint qui n'existe pas
        const { data } = await useFetch(`/api/campaigns/${this.currentCampaign.id}/scenarios/${scenarioId}`)
        // ...
    }
}
```

**Après (utilise la liste globale des scénarios) :**
```typescript
async loadScenario(scenarioId: number) {
    if (!this.currentCampaign) {
        console.error('Aucune campagne chargée')
        return
    }

    // 1. Chercher le scénario dans la campagne actuelle
    let scenario = this.currentCampaign.scenarios?.find(s => s.id === scenarioId)

    // 2. Si pas trouvé, chercher dans la liste globale
    if (!scenario) {
        console.log(`Scénario ${scenarioId} non trouvé dans la campagne, recherche dans la liste globale...`)
        const globalScenario = this.scenarios.find(s => s.id === scenarioId)

        if (!globalScenario) {
            console.error(`Scénario ${scenarioId} introuvable`)
            return
        }

        // 3. Créer un nouveau scénario pour cette campagne
        scenario = {
            id: globalScenario.id,
            name: globalScenario.name,
            imagePath: globalScenario.imagePath,
            isFinished: false,
            game: null
        }

        // 4. L'ajouter à la campagne
        if (!this.currentCampaign.scenarios) {
            this.currentCampaign.scenarios = []
        }
        this.currentCampaign.scenarios.push(scenario)
    }

    // 5. Charger le scénario
    this.currentScenario = scenario
    this.resetElements()

    // 6. Initialiser ou charger le jeu
    if (scenario.game) {
        console.log('Chargement du jeu existant')
        this.currentGame = scenario.game
    } else {
        console.log('Initialisation d\'un nouveau jeu')
        const { initializePlayersForGame } = useGame()

        this.currentGame = {
            monsterDeck: this.createDeck('MonsterDeck'),
            players: initializePlayersForGame(this.currentCampaign.players),
            rounds: []
        }

        scenario.game = this.currentGame
    }

    console.log('Scénario chargé:', this.currentScenario)
    console.log('Jeu initialisé:', this.currentGame)
}
```

### 2. Correction de `resetScenario()` - [stores/app.ts:254-272](stores/app.ts#L254-L272)

**Avant (avec appel API inexistant) :**
```typescript
async resetScenario() {
    if (!this.currentCampaign || !this.currentScenario) return

    this.resetElements()

    // ❌ Appel à un endpoint qui n'existe pas
    await useFetch(`/api/campaigns/${this.currentCampaign.id}/scenarios/${this.currentScenario.id}/reset`, {
        method: 'POST'
    })

    await this.loadScenario(this.currentScenario.id)

    // ...
}
```

**Après (réinitialisation locale) :**
```typescript
async resetScenario() {
    if (!this.currentCampaign || !this.currentScenario) return

    console.log('Réinitialisation du scénario')
    this.resetElements()

    const { initializePlayersForGame } = useGame()

    // Réinitialiser le jeu directement
    this.currentScenario.game = {
        monsterDeck: this.createDeck('MonsterDeck'),
        players: initializePlayersForGame(this.currentCampaign.players),
        rounds: []
    }

    this.currentGame = this.currentScenario.game

    console.log('Scénario réinitialisé')
}
```

## Flux de données corrigé

### Au chargement d'un scénario

```
1. Utilisateur clique sur un scénario (ex: Scénario 1)
   ↓
2. loadScenario(1) est appelé
   ↓
3. Cherche le scénario dans currentCampaign.scenarios
   - ✅ Trouvé → Utilise celui-ci
   - ❌ Pas trouvé → Cherche dans this.scenarios (liste globale)
   ↓
4. Crée un nouveau scénario pour la campagne si nécessaire
   ↓
5. Initialise currentGame avec :
   - monsterDeck: Deck de 20 cartes
   - players: Joueurs de la campagne avec HP max
   - rounds: []
   ↓
6. Navigue vers /game
   ↓
7. game.vue affiche tous les composants
```

### À la réinitialisation d'un scénario

```
1. Utilisateur clique sur le bouton "Reset"
   ↓
2. resetScenario() est appelé
   ↓
3. Réinitialise les éléments (état à 0)
   ↓
4. Recrée currentGame :
   - Nouveau deck mélangé
   - Joueurs avec HP réinitialisés
   - Rounds vides
   ↓
5. game.vue se rafraîchit automatiquement
```

## Logs de debug

Avec les nouveaux logs, vous verrez dans la console :

### Au chargement d'un scénario (première fois)

```
Scénario 1 non trouvé dans la campagne, recherche dans la liste globale...
Initialisation d'un nouveau jeu
Scénario chargé: { id: 1, name: "Scénario 1", ... }
Jeu initialisé: { players: [...], monsterDeck: {...}, rounds: [] }
```

### Au rechargement d'un scénario existant

```
Chargement du jeu existant
Scénario chargé: { id: 1, name: "Scénario 1", ... }
Jeu initialisé: { players: [...], monsterDeck: {...}, rounds: [...] }
```

### À la réinitialisation

```
Réinitialisation du scénario
Scénario réinitialisé
```

## Test de la solution

1. **Relancez le serveur** :
   ```bash
   npm run dev
   ```

2. **Testez le flux complet** :
   - Créez ou chargez une campagne
   - Naviguez vers `/scenarios`
   - Cliquez sur "Scénario 1"
   - ✅ Pas d'erreur 404
   - ✅ Navigation vers `/game` réussie
   - ✅ Tous les composants s'affichent

3. **Vérifiez les logs** :
   - Ouvrez la console (F12)
   - Vous devriez voir les logs de chargement du scénario
   - Pas d'erreur 404

4. **Testez le reset** :
   - Cliquez sur le bouton "Reset"
   - ✅ Le scénario se réinitialise
   - ✅ Pas d'erreur 404

## Pourquoi cette solution fonctionne

### Ancien flux (ne marchait pas)
```
loadScenario() → Appel API /api/campaigns/2/scenarios/1 → 404 ❌
```

### Nouveau flux (fonctionne)
```
loadScenario() → Cherche dans this.scenarios (chargé au démarrage) → Crée localement → ✅
```

## Endpoints qui existent vraiment

Voici la liste des endpoints qui existent réellement :

| Endpoint | Méthode | Fonction |
|----------|---------|----------|
| `/api/campaigns` | GET | Liste toutes les campagnes |
| `/api/campaigns` | POST | Crée une campagne |
| `/api/campaigns/:id` | GET | Récupère une campagne |
| `/api/scenarios` | GET | Liste tous les scénarios |
| `/api/elements` | GET | Liste tous les éléments |

## Endpoints qui n'existent PAS

| Endpoint inexistant | Pourquoi |
|-------------------|----------|
| `/api/campaigns/:id/scenarios/:scenarioId` | Plus nécessaire avec campaignScenarios |
| `/api/campaigns/:id/scenarios/:scenarioId/reset` | Réinitialisation côté client uniquement |

## Améliorations futures (optionnel)

Si vous voulez persister les scénarios en cours dans la base de données, vous pourriez :

1. **Créer un endpoint** `POST /api/campaign-scenarios` pour créer une entrée dans la table `CampaignScenario`
2. **Créer un endpoint** `POST /api/games` pour sauvegarder l'état du jeu
3. **Modifier le store** pour sauvegarder automatiquement lors des changements

Mais pour l'instant, la solution actuelle fonctionne parfaitement pour jouer localement ! ✅
